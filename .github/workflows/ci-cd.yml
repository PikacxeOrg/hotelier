name: Root CI/CD Pipeline

on:
  push:
    branches: [main, develop]
    tags:
      - "v*.*.*"
  pull_request:
    branches: [main, develop]

env:
  DOTNET_VERSION: "9.0.x"
  CONFIGURATION: Release
  REGISTRY: docker.io
  DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USERNAME }}
  PUSH_IMAGES: ${{ github.event_name == 'push' && (startsWith(github.ref, 'refs/heads/main') || startsWith(github.ref, 'refs/tags/v')) }}

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: Restore
        run: dotnet restore --locked-mode

      - name: Build
        run: dotnet build --no-restore -c ${{ env.CONFIGURATION }} -o out

      - name: Unit Tests
        run: dotnet test --no-build -c ${{ env.CONFIGURATION }} --collect:"XPlat Code Coverage" --logger trx --results-directory ./coverage

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-tests
          path: ./coverage

  integration-tests:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: Restore & Build
        run: |
          dotnet restore --locked-mode
          dotnet build --no-restore -c ${{ env.CONFIGURATION }}

      - name: Start infra services
        if: hashFiles('docker-compose.yml') != ''
        run: |
          docker compose -f docker-compose.yml up -d postgres mongodb rabbitmq
          # Wait for services readiness
          for service in postgres mongodb rabbitmq; do
            timeout 120 bash -c "until docker compose ps $service | grep -E '(Up.*healthy|Up.*healthy \\(health: starting\\))'; do sleep 3; done" || \
            timeout 120 bash -c "until docker compose ps $service | grep 'Up'; do sleep 3; done"
          done
          docker compose ps

      - name: Build services
        if: hashFiles('docker-compose.yml') != ''
        run: docker compose -f docker-compose.yml build availability-service accommodation-service identity-service notification-service cdn-service rating-service reservation-service search-service

      - name: Run integration tests
        if: hashFiles('docker-compose.yml') != ''
        run: |
          docker compose -f docker-compose.yml up -d availability-service accommodation-service identity-service notification-service cdn-service rating-service reservation-service search-service
          # Wait for app services
          sleep 10
          docker compose ps

      - name: Tear down
        if: always() && hashFiles('docker-compose.yml') != ''
        run: docker compose -f docker-compose.yml down -v

  docker-build-push:
    needs: [test, integration-tests]
    runs-on: ubuntu-latest
    if: ${{ env.PUSH_IMAGES == 'true' }}
    strategy:
      matrix:
        include:
          - service: availability-service
            dockerfile: services/availability-service/Dockerfile
          - service: accommodation-service
            dockerfile: services/accommodation-service/Dockerfile
          - service: identity-service
            dockerfile: services/identity-service/Dockerfile
          - service: notification-service
            dockerfile: services/notification-service/Dockerfile
          - service: cdn-service
            dockerfile: services/cdn-service/Dockerfile
          - service: rating-service
            dockerfile: services/rating-service/Dockerfile
          - service: reservation-service
            dockerfile: services/reservation-service/Dockerfile
          - service: search-service
            dockerfile: services/search-service/Dockerfile
          - service: gateway
            dockerfile: gateway/Dockerfile
          - service: hotelier-frontend
            dockerfile: hotelier-frontend/Dockerfile
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Set version tags
        id: ver
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
            echo "version=${VERSION}" >> $GITHUB_OUTPUT
            echo "tags=${VERSION},latest" >> $GITHUB_OUTPUT
          else
            BRANCH="${GITHUB_REF#refs/heads/}"
            echo "version=${BRANCH}" >> $GITHUB_OUTPUT
            echo "tags=${BRANCH}" >> $GITHUB_OUTPUT
          fi

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Docker Buildx setup
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: buildx-${{ runner.os }}-${{ matrix.service }}-${{ hashFiles(matrix.dockerfile, '**/docker-compose*.yml') }}
          restore-keys: |
            buildx-${{ runner.os }}-${{ matrix.service }}-

      - name: Build and Push ${{ matrix.service }}
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.DOCKERHUB_USER }}/${{ matrix.service }}:${{ steps.ver.outputs.tags }}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache,mode=max
          labels: |
            org.opencontainers.image.source=${{ github.event.repository.clone_url }}
            org.opencontainers.image.version=${{ steps.ver.outputs.version }}
            org.opencontainers.image.revision=${{ github.sha }}
