name: Root CI/CD Pipeline

on:
  push:
    branches: [main, develop]
    tags:
      - "v*.*.*"
  pull_request:
    branches: [main, develop]

env:
  DOTNET_VERSION: "9.0.x"
  CONFIGURATION: Release
  REGISTRY: docker.io
  DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USERNAME }}

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: Restore solution
        run: dotnet restore hotelier.sln --locked-mode

      - name: Build solution
        run: dotnet build hotelier.sln -c ${{ env.CONFIGURATION }}

      - name: Run unit tests (all services)
        run: |
          projects=(
            "services/accommodation-service/tests/AccommodationService.Tests/AccommodationService.Tests.csproj"
            "services/availability-service/tests/AvailabilityService.Tests/AvailabilityService.Tests.csproj"
            "services/identity-service/tests/IdentityService.Tests/IdentityService.Tests.csproj"
            "services/cdn-service/tests/CdnService.Tests/CdnService.Tests.csproj"
            "services/notification-service/tests/NotificationService.Tests/NotificationService.Tests.csproj"
            "services/reservation-service/tests/ReservationService.Tests/ReservationService.Tests.csproj"
            "services/rating-service/tests/RatingService.Tests/RatingService.Tests.csproj"
            "services/search-service/tests/SearchService.Tests/SearchService.Tests.csproj"
          )

          for proj in "${projects[@]}"; do
            name=$(basename "$proj" .csproj)
            echo "Running tests for $proj"
            dotnet test "$proj" \
              -c ${{ env.CONFIGURATION }} \
              --logger trx \
              --collect:"XPlat Code Coverage" \
              --results-directory "./coverage/$name"
          done

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-tests
          path: ./coverage

  integration-tests:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: Restore & Build
        run: |
          dotnet restore --locked-mode
          dotnet build --no-restore -c ${{ env.CONFIGURATION }}

      - name: Start infra services
        if: hashFiles('docker-compose.yml') != ''
        run: |
          docker compose -f docker-compose.yml up -d postgres mongodb rabbitmq
          for service in postgres mongodb rabbitmq; do
            timeout 120 bash -c "until docker compose ps $service | grep -E '(Up.*healthy|Up.*healthy \\(health: starting\\))'; do sleep 3; done" || \
            timeout 120 bash -c "until docker compose ps $service | grep 'Up'; do sleep 3; done"
          done
          docker compose ps

      - name: Run integration tests
        run: |
          projects=(
            "services/accommodation-service/tests/AccommodationService.Tests/AccommodationService.Tests.csproj"
            "services/availability-service/tests/AvailabilityService.Tests/AvailabilityService.Tests.csproj"
            "services/identity-service/tests/IdentityService.Tests/IdentityService.Tests.csproj"
            "services/notification-service/tests/NotificationService.Tests/NotificationService.Tests.csproj"
            "services/rating-service/tests/RatingService.Tests/RatingService.Tests.csproj"
            "services/reservation-service/tests/ReservationService.Tests/ReservationService.Tests.csproj"
            "services/search-service/tests/SearchService.Tests/SearchService.Tests.csproj"
            "services/cdn-service/tests/CdnService.Tests/CdnService.Tests.csproj"
          )
          for proj in "${projects[@]}"; do
            name=$(basename "$proj" .csproj)
            echo "Running integration tests for $proj"
            dotnet test "$proj" \
              -c ${{ env.CONFIGURATION }} \
              --filter "Category=Integration" \
              --logger trx \
              --results-directory "./coverage-integration/$name"
          done

      - name: Upload Integration Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-tests
          path: ./coverage-integration

      - name: Tear down
        if: always() && hashFiles('docker-compose.yml') != ''
        run: docker compose -f docker-compose.yml down -v

  docker-build-push:
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/tags/v'))
    needs: [test, integration-tests]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - service: availability-service
            dockerfile: services/availability-service/Dockerfile
            context: services/availability-service
          - service: accommodation-service
            dockerfile: services/accommodation-service/Dockerfile
            context: services/accommodation-service
          - service: identity-service
            dockerfile: services/identity-service/Dockerfile
            context: services/identity-service
          - service: notification-service
            dockerfile: services/notification-service/Dockerfile
            context: services/notification-service
          - service: cdn-service
            dockerfile: services/cdn-service/Dockerfile
            context: services/cdn-service
          - service: rating-service
            dockerfile: services/rating-service/Dockerfile
            context: services/rating-service
          - service: reservation-service
            dockerfile: services/reservation-service/Dockerfile
            context: services/reservation-service
          - service: search-service
            dockerfile: services/search-service/Dockerfile
            context: services/search-service
          # - service: gateway
          #   dockerfile: gateway/Dockerfile
          # - service: hotelier-frontend
          #   dockerfile: hotelier-frontend/Dockerfile
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Docker Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.DOCKERHUB_USER }}/${{ matrix.service }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=ref,event=branch
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Write Kaniko docker config
        run: |
          mkdir -p "${GITHUB_WORKSPACE}/.kaniko"
          printf '{"auths":{"https://index.docker.io/v1/":{"auth":"%s"}}}' \
            "$(printf '%s:%s' '${{ secrets.DOCKERHUB_USERNAME }}' '${{ secrets.DOCKERHUB_TOKEN }}' | base64 -w0)" \
            > "${GITHUB_WORKSPACE}/.kaniko/config.json"

      - name: Build and Push with Kaniko
        uses: docker://gcr.io/kaniko-project/executor:v1.23.0
        env:
          DOCKER_CONFIG: /github/workspace/.kaniko
        with:
          args: >-
            --dockerfile=/github/workspace/${{ matrix.dockerfile }}
            --context=dir:///github/workspace/${{ matrix.context }}
            --destination=${{ env.REGISTRY }}/${{ env.DOCKERHUB_USER }}/${{ matrix.service }}:${{ steps.meta.outputs.version }}
            ${{ (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')) && format('--destination={0}/{1}/{2}:latest', env.REGISTRY, env.DOCKERHUB_USER, matrix.service) || '' }}
            --cache=true
            --cache-repo=${{ env.REGISTRY }}/${{ env.DOCKERHUB_USER }}/cache
